<!DOCTYPE html>
<head>
<style>
td, th {
    text-align: left;
}

</style>
</head>
<h2>TDK Leaderboard</h2>
<div id="demo">
    Loading data, please wait...
</div>

<script>
mainpageurl = "https://cors-anywhere.herokuapp.com/http://dronesimulation.co.uk/events/evlbs.pl"
coreurl = "https://cors-anywhere.herokuapp.com/http://dronesimulation.co.uk/events/evlbs.pl?OM=DisplayLeaderboard&TRACK_ID="
droneurls = []


AjaxRequest = function(url, callback, failCallback) {
  var xmlhttp;

  if (window.XMLHttpRequest)
    xmlhttp=new XMLHttpRequest();
  else
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");

  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4) {
      if (xmlhttp.status == 200)
        callback(xmlhttp.responseText, url);
      else
        failCallback(url);
    }
  };

  xmlhttp.open("GET", url, true);
  xmlhttp.send();
};

AjaxRequestsMulti = function(urls, callbackMulti, failCallbackMulti)
{
  var isAllCallsCompleted = false;
  var isCallFailed = false;
  var data = {};

  for (var i=0; i<urls.length; i++) {
    var callback = function(responseText, url) {
      if (isCallFailed) return;

      data[url] = responseText;

      // get size of data
      var size = 0;
      for (var index in data) {
        if (data.hasOwnProperty(index))
          size ++;
      }

      if (size == urls.length)
        // all AJAX requests are completed successfully
        callbackMulti(data);
    };

    var failCallback = function(url) {
      isCallFailed = true;
      failCallbackMulti(url);
    };

    AjaxRequest(urls[i], callback, failCallback);
  }
};

var alltracksCallback = function(data) {
  //var respLines= data.responseText.split('\n')
  //console.log(data[droneurls[0]])
  var finalText = ""
  for (track = 0; track < droneurls.length; track++)
  {
    var respLines= data[droneurls[track]].split('\n');
    var text = "<table>";
    var get_score = false;

    for (i = 0; i < respLines.length; i++)
    {
        if (respLines[i].includes("Track:"))
        {
            text += "<tr><td></td><td><b>" + respLines[i].split("</B> ")[1].split("<BR>")[0] + "</b></td></tr>"
        }
        else if (respLines[i].includes("250 Racer Advanced"))
        {
            get_score = true;

        }
        else if (respLines[i].includes("250 Racer Custom") || respLines[i].includes("250 Racer Trainer"))
        {
            get_score = false;
        }
        else if (respLines[i].includes("[TDK]") && get_score)
        {
            var position = "<td>" + respLines[i-2].split("<p>")[1].split("</p>")[0] + "</td>"
            var name = "<td>" + respLines[i].split("</img>")[1].split("</p>")[0] + "</td>"
            var time = "<td>" + respLines[i+4].split("<p>")[1].split("</p>")[0] + "</td>"
            var gap = "<td>" + respLines[i+6].split("<p>")[1].split("</p>")[0] + "</td>"
            var missed = "<td>" + respLines[i+8].split("<p>")[1].split("</p>")[0] + "</td>"
            text += "<tr>" + position + name + time + gap + missed + "</tr>"
        }
    }
    text += "</table>"
    console.log("here");
    finalText += text

  }
  document.getElementById("demo").innerHTML = finalText;
}

var failtracksCallback = function(url)
{
  for(i in url)
  {
    console.log("Failed to get " + i)
  }
}

/*
  Callback for the mainpage request.
  This function fetches all the current TRACK_ID's on the list
  and uses this for getting results from all tracks.
*/

getmainPageCallback = function(text, url)
{
  // First get all TRACK_ID's from the main page
  var respLines= text.split('\n');
  for(line = 0; line<respLines.length; line++)
  {
    // console.log(respLines[line])
    if(respLines[line].includes("TRACK_ID"))
    {
      droneurls.push(coreurl + (respLines[line].split("TRACK_ID=")[1].split("'")[0]))
    }
    // console.log(droneurls)
  }
  //console.log(droneurls)

  // Now go fetch all the results
  AjaxRequestsMulti(droneurls, alltracksCallback, failtracksCallback)
}

AjaxRequest(mainpageurl, getmainPageCallback, getmainPageCallback)




</script>
